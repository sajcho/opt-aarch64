# Description:	Application development toolkit for controlling system-wide privileges
# URL:		http://www.freedesktop.org/wiki/Software/PolicyKit
# Maintainer:	sajcho, saux dot aarch64 at gmail dot com
# Depends on:	elogind glib util-linux nspr mozjs78 intltool gobject-introspection

name=polkit
version=0.120
release=1
source=(http://www.freedesktop.org/software/${name}/releases/${name}-${version}.tar.gz \
	polkit-1 \
	polkitd.run)

build() {
	cd ${name}-${version}

	CFLAGS+=" -Wno-deprecated-declarations"
	CXXFLAGS+=" -Wno-deprecated-declarations"

	build-meson \
		-Dsession_tracking=libelogind \
		-Dpolkitd_user=polkitd \
		-Dauthfw=pam \
		-Dintrospection=true \
		-Dsystemdsystemunitdir=/usr/share/dbus-1/services \
		. build

	meson compile ${JOBS:+-j ${JOBS}} -v -C build

	DESTDIR=$PKG meson install --no-rebuild -C build

	# See polkit's configure script which tells us what permissions to set
	chown -R polkitd:polkitd $PKG/etc/polkit-1/rules.d $PKG/usr/share/polkit-1/rules.d
	chmod -R 700 $PKG/etc/polkit-1/rules.d $PKG/usr/share/polkit-1/rules.d
	chmod 4755 $PKG/usr/lib/polkit-1/polkit-agent-helper-1
	chmod 4755 $PKG/usr/bin/pkexec

	install -m 0644 $SRC/polkit-1 $PKG/etc/pam.d

	# polkitd runit service
	install -d $PKG/etc/sv/polkitd
	install -m 0755 $SRC/polkitd.run $PKG/etc/sv/polkitd/run
	ln -s /run/runit/supervise.polkitd $PKG/etc/sv/polkitd/supervise

	rm -r $PKG/usr/share/locale
}
