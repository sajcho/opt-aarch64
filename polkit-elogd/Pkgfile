# Description:	Application development toolkit for controlling system-wide privileges
# URL:		http://www.freedesktop.org/wiki/Software/PolicyKit
# Maintainer:	sajcho, saux dot aarch64 at gmail dot com
# Depends on:	elogind glib util-linux nspr mozjs78 intltool gobject-introspection gtk-doc

name=polkit-elogd
_realname=polkit
version=0.119
release=0
source=(http://www.freedesktop.org/software/$_realname/releases/$_realname-$version.tar.gz \
	fix-elogind.patch \
	polkit-1 \
	polkitd.run)

build() {
	cd $_realname-$version

	patch -p1 -i $SRC/fix-elogind.patch

	CFLAGS+=" -Wno-deprecated-declarations"
	CXXFLAGS+=" -Wno-deprecated-declarations"

	autoreconf -fiv

	sed -e 's|/sys/fs/cgroup/systemd/|/sys/fs/cgroup|g' -i configure

	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--enable-libelogind=yes \
		--disable-libsystemd-login \
		--disable-static \
		--disable-nls \
		--with-authfw=pam

	make

	#make check

	make DESTDIR=$PKG install

	# See polkit's configure script which tells us what permissions to set
	chown -R polkitd:polkitd $PKG/etc/polkit-1/rules.d $PKG/usr/share/polkit-1/rules.d
	chmod -R 700 $PKG/etc/polkit-1/rules.d $PKG/usr/share/polkit-1/rules.d
	chmod 4755 $PKG/usr/lib/polkit-1/polkit-agent-helper-1
	chmod 4755 $PKG/usr/bin/pkexec

	install -m 0644 $SRC/polkit-1 $PKG/etc/pam.d

	# polkitd runit service
	install -d $PKG/etc/sv/polkitd
	install -m 0755 $SRC/polkitd.run $PKG/etc/sv/polkitd/run
	ln -s /run/runit/supervise.polkitd $PKG/etc/sv/polkitd/supervise

	rm $PKG/usr/share/polkit-1/actions/*.examples.*
	rm -r $PKG/usr/share/locale
}
