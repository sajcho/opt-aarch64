# Description:	JavaScript runtime built on V8 engine - LTS version
# URL:		http://nodejs.org/
# Maintainer:	sajcho, saux dot aarch64 at gmail dot com
# Depends on:	brotli c-ares icu libnghttp2 libuv openssl3 zlib

name=nodejs
_realname=node
version=17.3.0
release=1
source=(https://nodejs.org/dist/v${version}/${_realname}-v${version}.tar.xz \
	system-c-ares.patch)

build() {
	cd ${_realname}-v${version}

	patch -Rp1 -i $SRC/system-c-ares.patch

	# node has its own lto settings - we turn it off
	export CFLAGS="$(echo $CFLAGS | sed -e 's| -flto=auto -ffat-lto-objects||')"
	export CXXFLAGS="$(echo $CXXFLAGS | sed -e 's| -flto=auto -ffat-lto-objects||')"

	./configure \
		--prefix=/usr \
		--enable-lto \
		--shared-brotli \
		--shared-cares \
		--shared-libuv \
		--shared-nghttp2 \
		--shared-openssl \
		--shared-zlib \
		--with-intl=system-icu \
		--without-npm

	make V=1

	make DESTDIR=$PKG install

	rm -r $PKG/usr/share/doc

	# clean up
	find $PKG -type f \( \
		-name 'README.md' -o \
		-name 'AUTHORS.md' -o \
		-name 'INSTALL.md' -o \
		-name 'TODO.org' -o \
		-name 'ChangeLog' -o \
		-name 'NEWS' \) -delete
}
