# Description:	Standalone Mozilla JavaScript engine
# URL:		https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey
# Maintainer:	sajcho, saux dot aarch64 at gmail dot com
# Depends on:	autoconf-2.13 icu nspr rust

name=mozjs78
version=78.15.0
release=1
source=(https://ftp.mozilla.org/pub/firefox/releases/${version}esr/source/firefox-${version}esr.source.tar.xz \
	js-78.15.0-python_3_10-1.patch)

build() {
	cd firefox-${version}

	patch -p1 -i $SRC/js-78.15.0-python_3_10-1.patch

	mkdir obj
	cd obj

	export RUST_TARGET=$CHOST
	export RUSTFLAGS="-Cembed-bitcode"
	export CARGO_PROFILE_RELEASE_LTO="true"
	export CC="gcc"
	export CXX="g++"

	../js/src/configure \
		--prefix=/usr \
		--enable-hardening \
		--enable-optimize \
		--enable-readline \
		--enable-shared-js \
		--disable-debug \
		--disable-debug-symbols \
		--disable-jemalloc \
		--disable-tests \
		--with-intl-api \
		--with-system-icu \
		--with-system-nspr \
		--with-system-zlib

	make V=1

	make DESTDIR=$PKG install

	chmod -x $PKG/usr/lib/pkgconfig/*
	chmod -x $PKG/usr/include/mozjs-78/js-config.h

	# Prevent js78-config from using buggy CFLAGS.
	sed -i '/@NSPR_CFLAGS@/d' $PKG/usr/bin/js78-config

	rm $PKG/usr/lib/libjs_static.ajs
}
